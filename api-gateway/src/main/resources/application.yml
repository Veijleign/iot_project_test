server:
  port: 8090

spring:
  application:
    name: gateway-service

  security:
    oauth2:
      # Resource Server: проверяем входящий JWT
      resource-server:
        jwt:
          # Используем внутреннее имя контейнера Keycloak
          issuer-uri: http://keycloak:8080/realms/iot-realm
          # Для локальной разработки можно временно отключить SSL проверку
      #          jwk-set-uri: http://keycloak:8080/realms/iot-realm/protocol/openid-connect/certs

      # OAuth2 Client: для TokenRelay downstream
      client:
        registration:
          keycloak:
            client-id: gateway-client
            client-secret: ${KEYCLOAK_GATEWAY_SECRET}
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            scope:
              - openid
              - profile
              - email
        provider:
          keycloak:
            issuer-uri: http://keycloak:8080/realms/iot-realm


  cloud:
    gateway:
      server:
        webflux:
          routes:
            # User Service Routes
            - id: user-service
              uri: http://localhost:8080
              predicates:
                - Path=/api/v1/users/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 10
                    redis-rate-limiter.burstCapacity: 20

            # Device Service Routes
            - id: device-service
              uri: http://localhost:8080
              predicates:
                - Path=/api/v1/devices/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 50
                    redis-rate-limiter.burstCapacity: 100

            # Telemetry Service Routes
            - id: telemetry-service
              uri: http://localhost:8080
              predicates:
                - Path=/api/v1/telemetry/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 100
                    redis-rate-limiter.burstCapacity: 200

            # Analytics Service Routes
            - id: analytics-service
              uri: http://localhost:8080
              predicates:
                - Path=/api/v1/analytics/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 20
                    redis-rate-limiter.burstCapacity: 40

            # Alert Service Routes
            - id: alert-service
              uri: http://localhost:8080
              predicates:
                - Path=/api/v1/alerts/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 30
                    redis-rate-limiter.burstCapacity: 60
          default-filters:
            - TokenRelay  # Relay в Authorization всех маршрутов


  data:
    redis:
      host: redis
      port: 6379
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

# Management and Actuator
management:
  endpoints:
    web:
      exposure:
        include: health, info, metrics, prometheus
  endpoint:
    health:
      show-details: always
  prometheus:
    metrics:
      export:
        enabled: true

#logging:
#  level:
#    org.iot_platform: DEBUG
#    org.springframework.cloud.gateway: DEBUG
#    org.springframework.security: DEBUG
#    org.springframework.web.reactive: DEBUG
#  pattern:
#    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# Custom Application Properties
iot-platform:
  security:
    # Public endpoints that don't require authentication
    public-paths:
      - /actuator/**
      - /api/public/**
    # Admin-only endpoints
    admin-paths:
      - /api/admin/**
    # Rate limiting configuration
    rate-limiting:
      enabled: true
      default-rate: 10
      default-burst: 20